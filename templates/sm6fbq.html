<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="utf-8">
    <title>Synchronous Loading</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta property="og:title" content="">
    <meta property="og:type" content="">
    <meta property="og:url" content="">
    <meta property="og:image" content="">

    <link rel="apple-touch-icon" href="icon.png">
    <!-- Place favicon.ico in the root directory -->

    <link rel='stylesheet' href="{{ url_for('static',filename='css/main.css') }}">
    <link rel='stylesheet' href="{{ url_for('static',filename='css/style.css') }}">

    <link rel='stylesheet' href="{{ url_for('static',filename='fontawesome-free/css/all.css') }}">
    <link rel='stylesheet' href="{{ url_for('static',filename='fontawesome-free/css/fontawesome.css') }}">
    <link rel='stylesheet' href="{{ url_for('static',filename='fontawesome-free/css/solid.css') }}">
    <link rel='stylesheet' href="{{ url_for('static',filename='fontawesome-free/css/regular.css') }}">
    <link rel='stylesheet' href="{{ url_for('static',filename='fontawesome-free/css/brands.css') }}">


    <meta name="theme-color" content="#fafafa">

    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"
            integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg=="
            crossorigin="anonymous">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"
            integrity="sha512-aMGMvNYu8Ue4G+fHa359jcPb1u+ytAF+P2SCb+PxrjCdO3n3ZTxJ30zuH39rimUggmTwmh2u7wvQsDTHESnmfQ=="
            crossorigin="anonymous"></script>

    <script type="text/javascript">
        var socket
        var current_band


        $('.tooltip').mouseenter(function (e) {$('#target_list').show(200);});
        $('#antctrlhdr').mouseleave(function(e) {$('#target_list').hide(200);});

        $(document).ready(function () {
            var mypeer = 'http://' + document.domain + ':' + location.port;
            console.log("My peer="+mypeer)
            socket = io(mypeer)

            console.log("Connecting to server");

            socket.on('connect', function () {
                console.log("Connected");
                socket.emit('my event', {
                    data: 'Map display Connected'
                });
                clear_qso_table();

            });
            socket.on('my_response', function (msg, cb) {
                $('#log').append('<br>' + $('<div/>').text('Received #' + msg.count + ': ' + msg.data).html());
                if (cb)
                    cb();
            });

            socket.on('set_azel', function (msg) {
                // console.log("Got azEl " + msg.az + " " + msg.el);
                //confirm("Set_azel: " + msg.az + "/" + msg.el);
                $('#log').append('<br>' + $('<div/>').text('Received azel#' + msg.count + ': ' + msg.data).html());
                setAzimuth(msg.az);
                setElevation(msg.el);
            })

            socket.on("update_class", function (msg) {
                //console.log("Got update_class " + msg);
                $('#log').append('<br>' + $('<div/>').text('Received update_class#' + msg).html());
                updateClass(msg)
            })

            socket.on("update_classes", function (msg) {
                //console.log("Got update_classes " + msg);
                $('#log').append('<br>' + $('<div/>').text('Received update_class#' + msg).html());
                updateClasses(msg)
            })

            socket.on("update_state", function (msg) {
                //console.log("Got update_state " + msg);
                $('#log').append('<br>' + $('<div/>').text('Received update_state#' + msg).html());
                updateState(msg)
            })

            socket.on('set_origo', function (msg) {
                // console.log("Got origo " + msg.lat + " " + msg.lon);
                //confirm("Set_azel: " + msg.az + "/" + msg.el);
                $('#log').append('<br>' + $('<div/>').text('Received origo#' + msg.count + ': ' + msg.data).html());
                setOrigo(msg.lat, msg.lon, msg.zoom)
            })

            socket.on('set_qth', function (msg) {
                // console.log("Got origo " + msg.lat + " " + msg.lon);
                //confirm("Set_azel: " + msg.az + "/" + msg.el);
                $('#log').append('<br>' + $('<div/>').text('Received origo#' + msg.count + ': ' + msg.data).html());
                setQth(msg.lat, msg.lon, msg.qth, msg.n, msg.s, msg.w, msg.e)
            })

            socket.on('set_mydata', function (msg) {
                // console.log("Got mydata " + msg);
                setMyData(msg)
            })

            socket.on('add_rect', function (msg) {
                // console.log("Got rect " + msg.id)
                addRect(msg.id, msg.n, msg.s, msg.w, msg.e, msg.info, msg.hoverinfo);
            })

            socket.on('add_rects', function (rects) {
                // console.log("Got rects " + rects)
                for (const rect of rects) {
                    addRect(rect.id, rect.n, rect.s, rect.w, rect.e, rect.info, rect.hoverinfo);
                }
            })

            socket.on("add_qso", function (qso) {
                enter_qso_in_table(qso);
                console.log("added qso" + qso)
            })

            socket.on("add_qsos", function (qsos) {
                for (const qso of qsos) {
                    enter_qso_in_table(qso);
                }
            })

            socket.on("update_planes", function (planes)
            {
                console.log("update_planes" + planes)
                updatePlanes(planes)
            })

            socket.on("globalReload", function (msg) {
                location.reload();
            })

            socket.on("setMapZoom", function (msg) {
                console.log("setMapZoom" + msg)
                set_map_zoom(msg)
            })

            socket.on("fill_dx_note", function(msg) {
                console.log("fill_dx_note" + msg)
                fill_dx_note(msg)
            })

            socket.on("fill_dx_grid", function(msg) {
                console.log("fill_dx_grid" + msg)
                fill_dx_grid(msg)
            })

            socket.on("update_target_list", function(msg) {
                console.log("update_target_list" + msg)
                update_target_list(msg)
            })

            socket.on("update_reachable_stations", function(json) {
                console.log("update_reachable_stations" + json)
                updateReachableStations(json)
            })

            socket.on("hiding_logged_stations", function(msg) {
                hidingLoggedStations(msg)
            })

        });
    </script>


</head>
<body>
<table id="main_layout" style="border:none;">
    <tr>
        <th colspan="3">
            <div class="message_holder"></div>
        </th>
    </tr>
    <tr>
        <td>
            <table id="map_control" style="border:none;">
                <tr style="border:none;">
                    <td style="border:none;">
                        <fieldset>
                            <div id="antctrlhdr">
                                <legend>
                                    <a href="#"> Antennstyrning <span class="tooltip" id="target_list"></span></a>
                                </legend>
                            </div>
                            <!--suppress HtmlFormInputWithoutLabel -->

                            <button id="direct_cw" type="button" onmousedown="send_manual('cw')"  onmouseup="send_manual('stop')"  onmouseout="send_manual('stop')">CW</button>
                            <button id="direct_ccw" type="button" onmousedown="send_manual('ccw')" onmouseup="send_manual('stop')"  onmouseout="send_manual('stop')">CCW</button>
                            <br/>
                            <button id="auto_track" type="button" onclick="send_toggle_auto_track()" title="Auto track new entered objects">Auto</button>
                            <input id="track_input" style="text-transform: uppercase; width:6em;" type="text" class="trkaz" placeholder="Track az"
                                onkeydown="if (event.keyCode === 13) { send_track_az(); return false; }"/>
                            <button id="track_button" type="submit" onclick="send_track_az()" title="Track azimuth of object entered">Track</button>
                            <button id="calibrate_button" type="button" onclick="send_calibrate()" title="Calibrate indicator with real azimuth">Calibrate</button>
                            <button id="stop_button" type="button" onclick="send_stop()" title="Stop rotation">Stop</button>
                            <button id="release_button" type="button" onclick="send_release()" title="Stop tracking">Release</button>
                            <button id="pointing_north_button" type="button" onclick="send_az()" title="Adjust for actually pointing north">Pointing North</button>
                            <button id="track_wind_button" type="button" onclick="send_track_wind()" title="Track current wind direction"> Wind</button>
                            <button id="track_moon_button" type="button" onclick="send_track_moon()" title="Track the moon if above horizon" >Moon</button>
                            <button id="track_sun_button" type="button" onclick="send_track_sun()" title="Track the Sun if above the horizon">Sun</button>
                            <br/>
                            Az scan
                            <input id="az_scan_start" type="text" class="az_scan_start" size=10 placeholder="Från"/>
                            <input id="az_scan_stop" type="text" class="az_scan_stop" size=10 placeholder="Till"/>
                            <input id="az_scan_increment" type="text" class="az_scan_increment" size=4 placeholder="Steg"/>
                            <input id="az_scan_period" type="text" class="az_scan_period" size=4 placeholder="Period"/>
                            <input id="az_scan_sweeps" type="text" class="az_scan_sweeps" size=3 placeholder="Svep"/>
                            <button id="az_scan_go" type="button" onclick="az_scan()">Kör</button>
                            |
                            <button id="pop_target_button" type="button" onclick="pop_target()">Pop</button>
                            |
                            <button id="decrement_az_button" type="button" onclick="add_az(-10)">-10°</button>
                            <button id="increment_az_button" type="button" onclick="add_az(10)">+10°</button>
                        </fieldset>
                    </td>
                </tr>
            </table>
        </td>
        <td>
            <fieldset>
                <legend>Stationstatus</legend>
                <button id="track_led" style="color: #0066FF; font-size: 18px;" class="fa-power-off"></button>
                <label>
                    Az: <span id="myaz"></span>
                    El: <span id="myel"></span>
                </label>
                <button id="pa_ready_led" onclick="send_toggle_pa()">PA Redo</button>
                <button id="pa_active_led" onclick="send_toggle_qro()">QRO</button>
                <button id="trx_rx_led">RX</button>
                <button id="trx_tx_led">TX</button>
                <button id="rx70_led" onclick="send_toggle_rx70()">RX70</button>
                <button id="tx70_led" onclick="send_toggle_tx70()">TX70</button>
            </fieldset>
        </td>
        <td>

        </td>
        <td></td>
    </tr>
    <tr>
        <td rowspan="3" style="width:50%">
            <fieldset>
                <legend>Karta</legend>
                <div id="locatorButtons">
                    <button id="loc_fields" onclick="send_set_map_mh_length(2)">Fält</button>
                    <button id="loc_squares" onclick="send_set_map_mh_length(4)">Rutor</button>
                    <button id="loc_locators" onclick="send_set_map_mh_length(6)">Lokatorer</button>
                    <button id="loc_8char" onclick="send_set_map_mh_length(8)">8ch</button>
                    <button id="loc_10char" onclick="send_set_map_mh_length(10)">10ch</button>
                    <button id="loc_12char" onclick="send_set_map_mh_length(12)">12ch</button>
                </div>

                <button id="show_hide_aircraft" style="float: right;" onclick="send_toggle_aircraft_layer()">Göm flygplan</button>
                <button id="show_hide_logged_stations" style="float: right;" onclick="send_toggle_hide_logged_stations()">Göm loggade</button>
                <button id="show_hide_stations" style="float: right;" onclick="send_toggle_station_layer()">Göm stationer</button>

                <button id="store_map_settings"
                        style="align-content: end;"
                        onclick="send_map_status()">Spara kartinställning
                </button>
                <div id="map" class="map"></div>
            </fieldset>
        </td>
        <td>
            <table style="border:none;border-collapse: collapse;border-spacing: 0;border-width: 0px;">
                <tr>
                    <td>
                        <fieldset>
                            <legend>Stationsdata</legend>
                            <label>Callsign: </label> <span id="my_callsign"></span> <br/>
                            <label>Lokator:</label> <span id="my_qth">JO67BQ</span><br/>
                            <label>Antenn:</label> <span id="my_ant"></span><br/>
                            <label>Höjd över havet:</label> <span id="my_ant_asl"></span> m ASL<br/>
                            <label>Tx:</label> <span id="my_tx"></span> <span id="my_pwr"></span> W<br/>
                            <label>Rx:</label> <span id="my_rx"></span><br/>
                            <label for="band_select"> Frekvensband-TxMode:</label>
                            <select id="band_select" onchange="send_band()">
                                <option value="50">50</option>
                                <option value="50-FT8">50-FT8</option>
                                <option value="144">144</option>
                                <option value="144-FT8">144-FT8</option>
                                <option value="144-MSK">144-MSK</option>
                                <option value="432">432</option>
                                <option value="432-FT8">432-FT8</option>
                                <option value="1296">1296</option>
                            </select>
                            <br/>
                        </fieldset>
                    </td>
                    <td>
                        <textarea placeholder="Loggkommentar" id="log_remarks" rows="4" cols="50"></textarea>
                        <br/>
                        <button id="make_log" type="button" onclick="make_log()">Producera testlogg</button>
                        <hr/>
                        <input id="wsjtx_upload" type="file" name="wsjtx_upload"/>
                        <button id="wsjtx_upload-button" onclick="uploadWsjtxFile()"> Ladda upp WSJT-X logg</button>
                    </td>
                </tr>
            </table>
        </td>
        <td rowspan="3" style="width:20%">
            <fieldset>
                <legend>Operativa anteckningar</legend>
                <table id="notestable" class="calllog">
                    <tr>
                        <td id="note_id" style="display:none;"></td>
                        <td><!--suppress HtmlFormInputWithoutLabel -->
                            <input style="text-transform: uppercase; width:6em;" id="note_callsign" type="text"
                                   placeholder="Anropssignal"/></td>
                        <td><!--suppress HtmlFormInputWithoutLabel -->
                            <input style="text-transform: uppercase;width:6em;" id="note_locator" type="text"
                                   placeholder="Lokator"/></td>
                        <td><!--suppress HtmlFormInputWithoutLabel -->
                            <input style="width:6em;" id="note_frequency" type="text" placeholder="Frekvens"/></td>
                        <td id="commit_note_btn">
                            <button type="button"><i class="fa fa-check" onclick="commit_new_note()"></i></button>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </td>
    <tr>
        <td>
            <fieldset>

                <legend>
                    Logg
                    <button id="log_scope_forever" onclick="send_set_log_scope('Forever')">Totalt</button>
                    <button id="log_scope_today" onclick="send_set_log_scope('Today')">Idag</button>
                    <button id="log_scope_contest" onclick="send_set_log_scope('Contest')">Test</button>
                </legend>

                <div id="calllog" style="overflow-y:scroll; height:730px;">
                    <table id="logtable" class="calllog">
                        <tr/>
                        <tr>
                            <th>QSO ID</th>
                            <th style="width:4em;text-align:center;">Datum</th>
                            <th style="width:3em;text-align:center;">UTC
                            <th style="width:3em;text-align:center;">Band/Fq
                            <th>Anropssignal</th>
                            <th>Tx</th>
                            <th>Rx</th>
                            <th>Lok</th>
                            <th style="width:4em;">Avstånd</th>
                            <th style="width:4em;">Våg</th>
                            <th style="width:3em;text-align:center;">Poäng</th>
                            <th style="width:3em;text-align:center;">Ruta</th>
                            <th style="width:3em;text-align:center;">C/_</th>
                            <th></th>
                        </tr>
                        <tr>
                            <td id="qso_id"> </td>
                            <td><input style="width: 8em;" id="new_qso_date"></td>
                            <td><input style="width: 8em;" id="new_qso_time"></td>
                            <td><input style="width: 8em;" id="new_qso_band"></td>
                            <td><!--suppress HtmlFormInputWithoutLabel -->
                                <input style="text-transform: uppercase;width:6em;" id="new_callsign" type="text"
                                       placeholder="Anropssignal" onchange="begin_qso()"/></td>
                            <td><!--suppress HtmlFormInputWithoutLabel -->
                                <input style="width:5em" id="new_tx_rst" type="text"
                                       onchange="send_report()" list="reports"/>
                            </td>
                            <td><!--suppress HtmlFormInputWithoutLabel -->
                                <input style="width:5em" id="new_rx_rst" type="text" list="reports"/>
                            </td>
                            <td><!--suppress HtmlFormInputWithoutLabel -->
                                <input style="text-transform: uppercase;width:6em;" id="new_locator" type="text"
                                       placeholder="Lokator" onchange="added_locator()"/></td>
                            <td id="new_qso_distance" style="text-align: right"></td>
                            <td><!--suppress HtmlFormInputWithoutLabel -->
                                <input style="text-transform: uppercase;width:6em;" id="new_propmode" type="text"
                                       placeholder="Vågutbr" onchange="added_propmode()"/></td>
                            <td id="new_qso_points" style="text-align: right"></td>
                            <td id="new_qso_square" style="text-align: right"></td>
                            <td/>
                            <td id="commit_btn">
                                <button type="button"><i class="fa fa-check" onclick="commit_new_qso()"></i></button>
                                <button type="button"><i class="fa fa-minus" onclick="commit_incomplete_qso()"></i>
                                </button>
                            </td>
                        </tr>
                    </table>
                    <datalist id="reports">
                        <optgroup label="CW">
                            <option value="599">599</option>
                            <option value="589">589</option>
                            <option value="579">579</option>
                            <option value="569">569</option>
                            <option value="559">559</option>
                            <option value="549">549</option>
                            <option value="539">539</option>
                            <option value="529">529</option>
                            <option value="519">519</option>
                            <option></option>
                        </optgroup>
                        <optgroup label="Aurora">
                            <option value="59A">59A</option>
                            <option value="58A">58A</option>
                            <option value="57A">57A</option>
                            <option value="56A">56A</option>
                            <option value="55A">55A</option>
                            <option value="54A">54A</option>
                            <option value="53A">53A</option>
                            <option value="52A">52A</option>
                            <option value="51A">51A</option>
                        </optgroup>
                        <optgroup label="SSB">
                            <option value="59">59</option>
                            <option value="58">58</option>
                            <option value="57">57</option>
                            <option value="56">56</option>
                            <option value="55">55</option>
                            <option value="54">54</option>
                            <option value="53">53</option>
                            <option value="52">52</option>
                            <option value="51">51</option>
                        </optgroup>
                    </datalist>
                </div>
            </fieldset>
        </td>
    </tr>
    <tr>
        <td>
            <form action="" method="POST">
                <fieldset>
                    <legend>Morsesändare</legend>
                    <div class="slidecontainer">
                        <label for="cwSpeedSlider">Takt: <span id="cwSpeedValue"></span></label><br/>
                        <input type="range" min="60" max="150" value="90" class="slider" id="cwSpeedSlider">
                        <script>
                            let slider = document.getElementById("cwSpeedSlider");
                            let output = document.getElementById("cwSpeedValue");
                            output.innerHTML = slider.value;

                            slider.oninput = function () {
                                output.innerHTML = this.value;
                                set_cw_speed(this.value);
                            }
                        </script>
                        <br/>
                        <button id="send_cq_1" type="button" onclick="transmit_cq()">Sänd CQ</button>
                        <button id="send_cq_2" type="button" onclick="transmit_cq_test()">Sänd CQ test</button>
                        <button id="send_cq_3" type="button" onclick="transmit_cq_a()">Sänd CQ A</button>

                        <br/>

                    </div>
                </fieldset>
            </form>
        </td>
    </tr>
</table>


<form id="QSO" style="display: none">
    <label for="callsign">Callsign</label><br>
    <input type="text" id="callsign" name="call">
</form>
<div id="notes" class="notes"></div>

<script src="{{ url_for('static', filename='js/vendor/modernizr-3.11.2.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/plugins.js') }}"></script>
<script src="https://maps.googleapis.com/maps/api/js?key={{gapikey}}&v=weekly&libraries=geometry" ></script>

<script>
    const BUTTON = 'BUTTON';

    function initButtonGroup(buttonGroupId) {
        const buttonGroup = document.getElementById(buttonGroupId);
        const handleButtonGroupClick = createClickHandler(buttonGroupId);

        forEachButtonInGroup(buttonGroup, button => {
            button.addEventListener('click', handleButtonGroupClick);
        });
    }

    function createClickHandler(buttonGroupId) {
        return function (e) {
            const buttonGroup = document.getElementById(buttonGroupId);
            e.preventDefault();

            forEachButtonInGroup(buttonGroup, button => {
                button.className = '';
            });

            e.target.className = 'active';
        };
    }

    function forEachButtonInGroup(buttonGroup, callback) {
        for (let index = 0; index < buttonGroup.childNodes.length; index += 1) {
            const button = buttonGroup.childNodes[index];
            if (button.nodeName === BUTTON) {
                callback(button);
            }
        }
    }

    initButtonGroup('locatorButtons');
</script>
</script>

<script>
    async function uploadWsjtxFile() {
        let formData = new FormData();
        formData.append("file", wsjtx_upload.files[0]);
        await fetch('/wsjtx_upload', {
            method: "POST",
            body: formData
        });
        alert('The file has been uploaded successfully.');
    }
</script>

<script>
    var map = new google.maps.Map(document.getElementById("map"), {
            center: {lat: 0.0, lng: 0.0},
            zoom: 8,
        }
    );
</script>

<!--suppress JSUnusedLocalSymbols -->
<script>
    function download(filename, text) {
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);

        element.style.display = 'none';
        document.body.appendChild(element);

        element.click();

        document.body.removeChild(element);
    }

    function send_calibrate(az) {
        console.log("Sending calibrate");
        socket.emit('calibrate', {});
    }

    function send_stop(az) {
        console.log("Sending stop");
        socket.emit('stop', {});
    }

    function send_manual(what) {
        console.log("Sending manual " + what)
        socket.emit("manual", what)
    }

    function send_release(az) {
        send_stop();
        console.log("Sending release");
        socket.emit('untrack', {});
    }

    function send_az(az) {
        console.log("Pointing North");
        socket.emit('set_az', {'az': 0});
    }

    function send_toggle_qro() {
        console.log("Toggling qro")
        socket.emit("toggle_qro", {});
    }

    function send_toggle_pa() {
        console.log("Toggling PA")
        socket.emit("toggle_pa", {});
    }

    function send_toggle_rx70() {
        console.log("Toggling RX70")
        socket.emit("toggle_rx70", {});
    }

    function send_toggle_tx70() {
        console.log("Toggling TX70")
        socket.emit("toggle_tx70", {});
    }

    function send_toggle_auto_track() {
        console.log("Toggling auto-track")
        socket.emit("toggle_auto_track", {});
    }

    function make_log() {
        console.log("Making a log");
        band_select = document.getElementById("band_select").value;
        log_remarks = document.getElementById("log_remarks").value;
        socket.emit("make_log", {"band": band_select, "log_remarks": log_remarks});
        socket.once("log_data", function (json) {
                contest_log = json["contest_log"];
                download("contest_log.txt", contest_log);
            }
        );
    }

    function transmit_cq_test(az) {
        console.log("Sending CQ test");
        socket.emit('transmit_cw', {'msg': "cq cq cq test de sm6fbq sm6fbq test k"});
    }

    function transmit_cq(az) {
        console.log("Sending CQ");
        socket.emit('transmit_cw', {'msg': "cq cq cq de sm6fbq sm6fbq sm6fbq +k"});
    }

    function transmit_cq_a(az) {
        console.log("Sending CQ A");
        socket.emit('transmit_cw', {'msg': "cqa cqa cqa de sm6fbq sm6fbq sm6fbq +k"});
    }

    function send_track_az(az) {
        let track_az = $('input.trkaz').val()
        console.log("Tracking azimuth " + track_az);
        socket.emit('track_az', {'az': track_az});
    }

    function add_az(diff) {
        console.log("Add az: " + diff);
        socket.emit('add_az', {'diff': diff});
    }

    function send_track_wind(az) {
        console.log("Tracking the wind ");
        socket.emit('track_wind', {});
    }

    function send_track_moon(az) {
        console.log("Tracking the Moon ");
        socket.emit('track_moon', {});
    }

    function send_track_sun(az) {
        console.log("Tracking the Sun ");
        socket.emit('track_sun', {});
    }

    function pop_target(az) {
        console.log("Popping top target ");
        socket.emit('pop_target', {});
    }

    function set_cw_speed(speed) {
        console.log("Setting CW speed to " + speed);
        socket.emit('set_cw_speed', {'speed': speed});
    }

    function send_set_map_mh_length(len) {
        console.log("Setting mh map length to " + len);
        socket.emit("set_map_mh_length", {'length': len})
    }

    function send_set_log_scope(scope) {
        console.log("Setting log scope to " + scope);
        socket.emit("set_log_scope", {'scope': scope})
    }

    function send_map_status() {
        console.log("Sending map status");
        pos = map.getCenter();
        zoom = map.getZoom();

        console.log("Sending map status:" + pos.lat() + " " + pos.lng() + " " + zoom);
        socket.emit("map_settings", {"lat": pos.lat(), "lon": pos.lng(), "zoom": zoom});
    }

    function send_toggle_hide_logged_stations()
    {
        console.log("Toggling hide logged stations")
        socket.emit("toggle_hide_logged_stations",{})
    }

    function send_toggle_aircraft_layer()
    {
        console.log("Toggling aircraft layers")
        socket.emit("toggle_aircraft_layer",{})
    }

     function send_toggle_station_layer()
    {
        console.log("Toggling station layers")
        socket.emit("toggle_station_layer",{})
    }

    function az_scan() {
        let start = $('input.az_scan_start').val();
        let stop =  $('input.az_scan_stop').val();
        let increment = $('input.az_scan_increment').val();
        let period = $('input.az_scan_period').val();
        let sweeps = $('input.az_scan_sweeps').val();
        console.log("Scanning azimuth"+start+" "+ stop+" "+increment+" "+period+" "+sweeps);
        socket.emit('az_scan_go', {"start":start,"stop":stop, "increment":increment, "period":period,"sweeps":sweeps});
    }

    function planeClick(plane_id) {
        console.log("Clicked on plane " + plane_id);
        socket.emit('plane_click', plane_id);
    }

    function stationClick(callsign) {
        console.log("Clicked on station " + callsign);
        socket.emit('station_click', callsign);
    }
</script>

<script>

    var upstreamIcon = {
        path: 'M28.6,17.5' +
            'L16.1,4.9' +
            'l0,0 ' +
            'c-0.1-0.1-0.2-0.2-0.3-0.2' +
            'c0,0-0.1,0-0.1-0.1' +
            'c-0.1,0-0.1-0.1-0.2-0.1' +
            'c-0.1,0-0.1,0-0.2-0.1' +
            'c0,0-0.1,0-0.1,0' +
            'c-0.1,0-0.2,0-0.3,0 ' +
            'c0,0,0,0,0,0l0,0' +
            'c-0.1,0-0.2,0-0.3,0' +
            'c-0.1,0-0.1,0-0.1,0' +
            'c-0.1,0-0.1,0-0.2,0.1' +
            'c-0.1,0-0.1,0.1-0.2,0.1' +
            'c0,0-0.1,0-0.1,0.1 ' +
            'c-0.1,0.1-0.2,0.1-0.3,0.2' +
            'c0,0,0,0,0,0l0,0' +
            'c0,0,0,0,0,0' +
            'L1,17.5' +
            'l0,0' +
            'c-0.7,0.7-0.7,1.8,0,2.5' +
            's1.8,0.7,2.5,0' +
            'l9.6-9.6 ' +
            'c0,6.7,0,34.2,0,34.2' +
            'c0,1,0.8,1.7,1.7,1.7' +
            's1.7-0.8,1.7-1.7' +
            'V10.4l9.6,9.6' +
            'c0.7,0.7,1.8,0.7,2.5,0' +
            'S29.3,18.2,28.6,17.5' +
            'z',

        fillColor: '#fbb040',
        fillOpacity: 1,
        scale: 1.5,
        strokeColor: '#000',
        strokeWeight: 0.5,
        origin: new google.maps.Point(0, 0),
        anchor: new google.maps.Point(15, 50),
        rotation: 0,
    }

    var planeIcon = {
        path: 'm-246.683655,-59.615128l15.387878,-16.184708c9.011322,-9.011322 24.185303,-5.885406 24.185303,-5.885406l45.029465,6.161377l22.806168,-22.315704c12.015106,-11.800537 22.866943,6.253754 18.146729,12.475861l-11.709442,13.610046l48.493378,8.981598l16.460663,-19.189117c17.593536,-21.026459 30.683319,-2.083527 22.744781,9.073364l-10.636658,13.456879l72.862823,9.502472c62.650269,-60.290161 88.227356,-85.29892 104.711334,-70.441315c16.590332,14.9534 -12.756226,44.758545 -69.828003,103.546799l10.360687,75.069748l15.265106,-12.720795c9.011322,-7.50943 25.011871,4.537964 8.491058,20.2005l-20.997314,19.801788l8.858795,49.137024l13.119537,-10.084778c11.585999,-9.225861 25.655548,2.97467 9.992981,19.710022l-20.844177,20.997345c-0.858215,0.643646 6.805023,43.09845 6.805023,43.09845c4.720215,20.81189 -7.019592,28.415619 -7.019592,28.415619l-14.315094,12.475891l-54.378754,-153.603455c-4.505676,-13.516998 -15.925018,-28.19577 -35.006104,-26.453613c-10.084106,1.072784 -35.557983,18.269501 -38.990875,22.346069l-58.976837,56.708466c-1.501892,1.072784 9.073364,73.721039 9.073364,73.721039c0,2.145569 -18.698608,26.668213 -18.698608,26.668213l-37.366226,-66.517303l-18.453049,8.582855l10.789795,-16.798004l-67.283752,-37.979492l25.227692,-18.453033c12.015121,2.789215 75.008392,9.870178 76.295715,9.226501c0,0 51.296906,-50.87262 54.225616,-53.949646c16.94989,-17.808105 22.653015,-24.461853 25.227661,-33.258636c2.576782,-8.804016 -1.812836,-21.705841 -28.415619,-38.040894c-36.689026,-22.528351 -151.641449,-61.092026 -151.641449,-61.092026z',
        fillColor: '#f3db79',
        fillOpacity: 1,
        scale:0.07,
        strokeColor: "#000",
        strokeWeight: 1,
        anchor: new google.maps.Point(0,0),
        rotation: 45,
    }

    var planesDict = new Object();
    var stationsDict = new Object();

     Number.prototype.toRad = function() {
         return this * Math.PI / 180;
    }

    Number.prototype.toDeg = function() {
         return this * 180 / Math.PI;
    }

    google.maps.LatLng.prototype.destinationPoint = function(frompoint, bearing, dist) {
         dist = dist / 6371;
         bearing = bearing.toRad();

         var lat1 = frompoint.lat.toRad(), lon1 = frompoint.lng.toRad();

         var lat2 = Math.asin(Math.sin(lat1) * Math.cos(dist) +
                              Math.cos(lat1) * Math.sin(dist) * Math.cos(bearing));

         var lon2 = lon1 + Math.atan2(Math.sin(bearing) * Math.sin(dist) *
                                      Math.cos(lat1),
                                      Math.cos(dist) - Math.sin(lat1) *
                                      Math.sin(lat2));

         if (isNaN(lat2) || isNaN(lon2)) return null;

         return {lat: lat2.toDeg(), lng: lon2.toDeg()};
      }

    var my_lat = 58.0;
    var my_lng = 13.0;

    var marker = new google.maps.Marker({
        position: {lat: my_lat, lng: my_lng},
        icon: upstreamIcon,
        draggable: true,
        map: map,
    });


    var antdir = new google.maps.Polyline({
        path:[
            {lat:my_lat, lng:my_lng},
            google.maps.LatLng.prototype.destinationPoint({lat:my_lat, lng:my_lng}, 22.2, 500)],
            geodesic:true,
            strokeColor:"#fe0000",
            strokeWeight:3,
            strokeOpacity:1,
            map: map});


    const infowindow = new google.maps.InfoWindow({
        content: "<p>Marker Location:</p>",
    });





    google.maps.event.addListener(marker, "click", () => {
        infowindow.content = "<p>Marker Location:" + marker.getPosition() + "</p><p>Rotation:" + marker.icon.rotation + "</p>"
        infowindow.open(map, marker);
    });



    function addPlane(key, id, longitude, latitude, alt, direction) {
        // console.log("Adding plane at ", longitude, latitude)
        var thePlaneIcon =
            {
                path: 'm-246.683655,-59.615128l15.387878,-16.184708c9.011322,-9.011322 24.185303,-5.885406 24.185303,-5.885406l45.029465,6.161377l22.806168,-22.315704c12.015106,-11.800537 22.866943,6.253754 18.146729,12.475861l-11.709442,13.610046l48.493378,8.981598l16.460663,-19.189117c17.593536,-21.026459 30.683319,-2.083527 22.744781,9.073364l-10.636658,13.456879l72.862823,9.502472c62.650269,-60.290161 88.227356,-85.29892 104.711334,-70.441315c16.590332,14.9534 -12.756226,44.758545 -69.828003,103.546799l10.360687,75.069748l15.265106,-12.720795c9.011322,-7.50943 25.011871,4.537964 8.491058,20.2005l-20.997314,19.801788l8.858795,49.137024l13.119537,-10.084778c11.585999,-9.225861 25.655548,2.97467 9.992981,19.710022l-20.844177,20.997345c-0.858215,0.643646 6.805023,43.09845 6.805023,43.09845c4.720215,20.81189 -7.019592,28.415619 -7.019592,28.415619l-14.315094,12.475891l-54.378754,-153.603455c-4.505676,-13.516998 -15.925018,-28.19577 -35.006104,-26.453613c-10.084106,1.072784 -35.557983,18.269501 -38.990875,22.346069l-58.976837,56.708466c-1.501892,1.072784 9.073364,73.721039 9.073364,73.721039c0,2.145569 -18.698608,26.668213 -18.698608,26.668213l-37.366226,-66.517303l-18.453049,8.582855l10.789795,-16.798004l-67.283752,-37.979492l25.227692,-18.453033c12.015121,2.789215 75.008392,9.870178 76.295715,9.226501c0,0 51.296906,-50.87262 54.225616,-53.949646c16.94989,-17.808105 22.653015,-24.461853 25.227661,-33.258636c2.576782,-8.804016 -1.812836,-21.705841 -28.415619,-38.040894c-36.689026,-22.528351 -151.641449,-61.092026 -151.641449,-61.092026z',

                fillColor: '#f3db79',
                fillOpacity: 1,
                scale: 0.07,
                strokeColor: "#000",
                strokeWeight: 1,
                anchor: new google.maps.Point(0, 0),
                labelOrigin: new google.maps.Point(13.5/0.07, 30/0.07),
                rotation: direction,
            };

        var aPlane = new google.maps.Marker({
            icon: thePlaneIcon,
            position: {lat: latitude, lng: longitude},
            opacity: 1.0,
            zIndex: 15,
            label: id,
            map: map,
        });

        aPlane.addListener("click", () => {
            planeClick(id)
        });
        planesDict[key] = aPlane
    }

    function addStation(key, callsign, position, direction, antwidth, txmode, age, info) {
        if (age > 3600) {return}
        // console.log("Adding station ", callsign, " at ", position, " width", antwidth, txmode)

        r = 50
        let v1x = r*Math.cos((antwidth/2+90)*Math.PI/180)
        let v2x = -v1x
        let v2y = r*Math.sin((antwidth/2+90)*Math.PI/180)
        let v1y = v2y




        //console.log( "adding Station: direction:", direction,  "width:", antwidth, "txmode:", txmode)

        fillcolor = '#e8578e';
        if (txmode=='MSK144') {
             fillcolor = '#3c46b0';
        }
        if (txmode=='JT65' || txmode=='JT65B')
            {
             fillcolor = '#8d5008';
        }
        if (txmode.startsWith('B/'))
            {
             fillcolor = '#50b7f5';
        }


        // Pick your pin (hole or no hole)
        var pinSVGHole = "M12,11.5A2.5,2.5 0 0,1 9.5,9A2.5,2.5 0 0,1 12,6.5A2.5,2.5 0 0,1 14.5,9A2.5,2.5 0 0,1 12,11.5M12,2A7,7 0 0,0 5,9C5,14.25 12,22 12,22C12,22 19,14.25 19,9A7,7 0 0,0 12,2Z";
        var labelOriginHole = new google.maps.Point(12,15);
        var pinSVGFilled = "M 12,2 C 8.1340068,2 5,5.1340068 5,9 c 0,5.25 7,13 7,13 0,0 7,-7.75 7,-13 0,-3.8659932 -3.134007,-7 -7,-7 z";
        var labelOriginFilled =  new google.maps.Point(12,9);

        fillopacity = 1-age/60

        var otherStationIcon = {
            path: pinSVGFilled,
            anchor: new google.maps.Point(12,17),
            fillOpacity: fillopacity,
            fillColor: fillcolor,
            strokeWeight: 2,
            strokeColor: "white",
            scale: 2,
            labelOrigin: labelOriginFilled
        };

        // this.marker        = new google.maps.Marker({
        //     map: map.MapObject,
        //     //OPTIONAL: label: label,
        //     position: this.geographicCoordinates,
        //     icon: markerImage,
        //     //OPTIONAL: animation: google.maps.Animation.DROP,
        // });

        beamPath = `M ${v1x},0.0  L 0.0,${v1y} L ${v2x},0.0`
        var beamingStationIcon = {
                path: beamPath,
                fillColor: fillcolor,
                fillOpacity: fillopacity,
                scale: 1.0,
                strokeColor: "#b879f3",
                strokeWeight: 1,
                anchor: new google.maps.Point(0, r),
                labelOrigin: new google.maps.Point(13.5, 60),
                rotation: direction,
            };

        if (antwidth >= 360) {
            theStationIcon = otherStationIcon
        } else
            theStationIcon = beamingStationIcon

        var aStation = new google.maps.Marker({
            icon: theStationIcon,
            position: position,
            opacity: 1.0,
            zIndex: 14,
            label:callsign,
            rotation: direction,
            map: map,
        })

        aStation['infowindow'] = new google.maps.InfoWindow({content: info});

        google.maps.event.addListener(aStation, 'mouseover', function() {
            this['infowindow'].open(map, this);
        });

        google.maps.event.addListener(aStation, 'mouseout', function() {
            this['infowindow'].close(map, this);
        });


        aStation.addListener("click", () => {
            stationClick(callsign)
        });

        stationsDict[key] = aStation

    }

    function removePlane(key) {
        plane = planesDict[key]
        planesDict[key].setMap(null);
        delete planesDict[key]
    }

    function removeStation(key) {
        stationsDict[key].setMap(null);
        delete stationsDict[key]
    }

    function updatePlanes(planes)
    {
         for (key in planes) {
                p = planes[key]
                if (key in planesDict) {
                    removePlane(key)
                    addPlane(key, p.id, p.lng, p.lat, p.alt, p.direction-45)
                }
                else {
                    addPlane(key, p.id, p.lng, p.lat, p.alt, p.direction-45)
                }
         }
         for (key in planesDict ){
             if (!(key in planes)) {
                 removePlane(key)
             }
         }
    }

    function updateReachableStations(stations)
    {
         for (key in stations) {
                stn = stations[key]
                if (key in stationsDict) {
                    removeStation(key)
                }
                addStation(key, stn.callsign, stn.position, stn.antenna_azimuth, stn.antenna_width, stn.txmode, stn.age, stn.info)

         }
         for (key in stationsDict ){
             if (!(key in stations)) {
                 removeStation(key)
             }
         }
    }

    function hidingLoggedStations(hiding)
    {
        if (hiding)
            document.getElementById("show_hide_logged_stations").innerHTML = "Visa loggade"
        else
            document.getElementById("show_hide_logged_stations").innerHTML = "Göm loggade"
    }


    function setAzimuth(az) {
        var icon = marker.getIcon();
        icon.rotation = az;
        marker.setIcon(icon);
        document.getElementById("myaz").innerHTML = az


        antdir.setPath(
        [
            {lat:my_lat, lng:my_lng},
            google.maps.LatLng.prototype.destinationPoint({lat:my_lat, lng:my_lng}, az, 1500)
        ]);

    }

    function setElevation(el) {
        document.getElementById("myel").innerHTML = el
    }


    function setOrigo(lat, lon, zoom) {
        map.setCenter({"lat": lat, "lng": lon});
        map.setZoom(zoom);
        //console.log("Moved map center to " + lat + " " + lon, "zoom=" + zoom);
    }

    function setQth(lat, lon, qth, n, s, w, e) {
        my_lat = lat
        my_lng = lon
        marker.setPosition({"lat": lat, "lng": lon});
        document.getElementById("my_qth").innerHTML = qth;
        console.log("Moved qth to " + lat + " " + lon);
        addRect(qth, n, s, w, e);
        antdir.path =
        [
            {lat:my_lat, lng:my_lng},
            google.maps.LatLng.prototype.destinationPoint({lat:my_lat, lng:my_lng}, 22.2, 500)
        ]
    }


    function updateClass(msg) {
        //console.log(msg)
        //console.log("ForID=", msg.forId)
        element = document.getElementById(msg.forId)
        //console.log("Element==", element)
        if (msg.value) {
            element.classList.add(msg.class);
        } else {
            element.classList.remove(msg.class);
        }
    }

    function updateClasses(msg) {
        //console.log(msg)
        //console.log("ForID=", msg.forId)
        element = document.getElementById(msg.forId)
        //console.log("Element==", element)
        element.className = msg.classes
    }

    function updateState(msg) {
        //console.log(msg)
        //console.log("ForID=", msg.forId)
        element = document.getElementById(msg.forId)

        //console.log("Element=", element)
        if (msg.state == 'disabled')
            element.disabled=msg.value
    }

    function setMyData(msg) {
        document.getElementById("my_callsign").innerHTML = msg.my_callsign;
        document.getElementById("my_ant").innerHTML = msg.my_ant;
        document.getElementById("my_ant_asl").innerHTML = msg.my_ant_asl;
        document.getElementById("my_tx").innerHTML = msg.my_tx;
        document.getElementById("my_rx").innerHTML = msg.my_rx;
        document.getElementById("my_pwr").innerHTML = msg.my_pwr;
        current_band = msg.current_band;
        document.getElementById("band_select").value = current_band;
    }

    function createClickablePoly(poly, html, map, infowinpos) {
        var contentString = html;
        var infoWindow = new google.maps.InfoWindow();
        google.maps.event.addListener(poly, 'click', function (event) {
            infoWindow.setContent(contentString);
            infoWindow.setPosition(event.latLng);
            infoWindow.open(map);
        });
        google.maps.event.addListener(poly, 'mouseout', function (event) {
            infoWindow.close(map);
        });
    }

    function createHoverPoly(poly, html, map, infowinpos) {
        var contentString = html;
        var infoWindow = new google.maps.InfoWindow();
        google.maps.event.addListener(poly, 'mouseover', function (event) {
            infoWindow.setContent(contentString);
            infoWindow.setPosition(event.latLng);
            infoWindow.open(map);
        });
        google.maps.event.addListener(poly, 'mouseout', function (event) {
            infoWindow.close(map);
        });
    }

    function addRect(id, n, s, w, e, infocontent, hoverinfo) {


        var my_rect = new google.maps.Rectangle();
        my_rect.setOptions({
            strokeColor: "#255f58",
            strokeOpacity: 0.8,
            strokeWeight: 1,
            fillColor: "#3f4738",
            fillOpacity: 0.07,
            editable: false,
            id: id,
            map,
            bounds: {"north": n, "south": s, "west": w, "east": e}
        })

        infowinpos = new google.maps.LatLng(n, w + (e - w) / 2)

        if (hoverinfo) {
            createHoverPoly(my_rect, infocontent, map, infowinpos);
        } else{
            createClickablePoly(my_rect, infocontent, map, infowinpos);
        }


        // console.log("Added rect with id=", id)

    }

    var new_qso = {};
    var new_note = {};

    function begin_qso() {
        new_qso['callsign'] = document.getElementById('new_callsign').value;

        if (document.getElementById('new_qso_date').value.length == 0) {
            new_qso['date'] = new Date().toISOString().split('T')[0];
            document.getElementById('new_qso_date').value = new_qso['date'];
        } else {
            new_qso['date'] = document.getElementById('new_qso_date').value;
        }

        if (document.getElementById('new_qso_time').value.length == 0) {
            let time = new Date().toISOString().split('T')[1];
            new_qso['time'] = time.substring(0, 2) + time.substring(3, 5);
            document.getElementById('new_qso_time').value = new_qso['time'];
        } else {
            new_qso['time'] = document.getElementById('new_qso_time').value
        }
        document.getElementById("new_tx_rst").disabled = false
    }

    function send_report() {
        console.log("Trying to send report")
        tx_report = document.getElementById("new_tx_rst").value
        rx_report = document.getElementById("new_rx_rst").value
        new_loc = document.getElementById("new_locator").value
        if (tx_report.length > 3) {
            console.log("Sending report")
            if (rx_report.length >= 2 && new_loc.length == 6) {
                console.log("Sending report with R")
                socket.emit('transmit_cw', {'msg': ` R TNX ur ${tx_report} ${tx_report}/JO67BQ JO67BQ §`});
            } else {
                console.log("Sending report without R")
                socket.emit('transmit_cw', {'msg': `${new_qso['callsign']} de sm6fbq ur ${tx_report} ${tx_report}/JO67BQ JO67BQ §`});
            }
            document.getElementById("new_tx_rst").disabled = true
        } else {
            console.log("No report sent")
        }
    }

    function send_band() {
        console.log("Trying to send band_select")
        band_select = document.getElementById("band_select").value
        socket.emit('band_select', {'band': band_select});
    }

    function make_qso(id) {

        console.log("Making qso from note ", id)
        let myTab = document.getElementById('notestable');
        rowid = table_id_to_row(myTab, id)
        remote_callsign = myTab.rows[rowid].cells[1].innerHTML
        remote_locator = myTab.rows[rowid].cells[2].innerHTML

        new_qso['callsign'] = remote_callsign
        new_qso['locator'] = remote_locator
        new_qso['date'] = new Date().toISOString().split('T')[0];
        let time = new Date().toISOString().split('T')[1];
        new_qso['time'] = time.substring(0, 2) + time.substring(3, 5);
        document.getElementById('new_qso_date').value = new_qso['date'];
        document.getElementById('new_qso_time').value = new_qso['time'];
        document.getElementById('new_qso_band').value = new_qso['band'];
        document.getElementById('new_callsign').value = new_qso['callsign'];
        document.getElementById('new_locator').value = new_qso['locator'];
        added_locator()
        document.getElementById("new_tx_rst").disabled = false
    }

    function added_locator() {
        new_qso['locator'] = document.getElementById('new_locator').value;
        socket.emit("lookup_locator", new_qso);
        json = lookup_locator_data();
        console.log("Locator lookup result", json);
        document.getElementById("new_qso_distance").innerText = json["distance"]
        document.getElementById("new_qso_square").innerText = json["square"]
        document.getElementById("new_qso_points").innerText = json["points"]

    }

    function lookup_locator_data() {
        socket.once("locator_data", function (json) {
            console.log("Locator lookup result", json);
            new_qso['distance'] = json["distance"]
            new_qso['square'] = json['square']
            new_qso['points'] = json['points']
            return json
        });
    }

    function added_propmode() {
        new_qso['propmode'] = document.getElementById('new_propmode').value;
    }

    function fill_dx_grid(msg) {
        var trackTo = document.getElementById("track_input");
        trackTo.value = msg;
    }

     function update_target_list(msg) {
        var tgtList = document.getElementById("target_list");
        console.log("Target list update ", msg)
        tgtList.innerHTML = msg;
    }

    function fill_dx_note(json) {
        document.getElementById("note_callsign").value = json["callsign"]
        document.getElementById("note_locator").value = json["locator"]
        document.getElementById("note_frequency").value = json["frequency"]
    }

    function update_qso_in_table(qso, row) {
        var rowcells = document.getElementById("logtable").rows[row].cells;
        col = 0;
        console.log("Updating log table row ", row, "with qso=", qso);

        rowcells[col++].value=qso["id"];
        rowcells[col++].innerText=qso["date"];
        rowcells[col++].innerText=qso["time"];
        rowcells[col++].innerText=qso["band"];
        rowcells[col++].innerText=qso["callsign"];
        rowcells[col++].innerText=qso["tx"];
        rowcells[col++].innerText=qso["rx"];
        rowcells[col++].innerText=qso["locator"];
        rowcells[col++].innerText=qso["distance"];
        rowcells[col++].innerText=qso["propmode"];
        rowcells[col++].innerText=qso["points"];
        rowcells[col++].innerText=qso["square"];
        rowcells[col++].innerText=qso["complete"]?"C":"-";
    }


    function enter_qso_in_table(qso) {

        var table = document.getElementById("logtable");
        // rowcount = table.rows.length
        var row = table.insertRow(3);
        col = 0;
        var qso_id = row.insertCell(col++);
        // qso_id.style = "display:none";
        var date = row.insertCell(col++);
        var time = row.insertCell(col++);
        var band = row.insertCell(col++);
        var callsign = row.insertCell(col++);
        var tx = row.insertCell(col++);
        var rx = row.insertCell(col++);
        var loc = row.insertCell(col++);
        var distance = row.insertCell(col++);
        distance.style = "text-align:right";
        var propmode = row.insertCell(col++);
        var points = row.insertCell(col++);
        points.style = "text-align:right";
        var acc_sqn = row.insertCell(col++);
        acc_sqn.style = "text-align:right";
        var completeness = row.insertCell(col++);
        var action = row.insertCell(col++);

        let qsoid = qso["id"]

        qso_id.innerHTML = qsoid;
        date.innerHTML = qso["date"];
        time.innerHTML = qso["time"];
        band.innerHTML = qso["band"];
        callsign.innerHTML = qso["callsign"].toUpperCase()
        tx.innerHTML = qso["tx"]
        rx.innerHTML = qso["rx"]
        if(qso["locator"]){
            loc.innerHTML = qso["locator"].toUpperCase()
        }
        distance.innerHTML = qso["distance"]
        propmode.innerHTML = qso["propmode"]
        // square.innerHTML = qso["square"]
        acc_sqn.innerHTML = qso["acc_sqn"]
        if (qso["complete"]) {
            points.innerHTML = qso["points"]
            completeness.innerHTML = "C"
        } else {
            completeness.innerHTML = "-"
        }
        //action.innerHTML =  '<button type="button"><i class="fa fa-ban" onclick="delete_qso(${qso["id"]})"></i> </button>'
        action.innerHTML += '<button type="button"><i class="fa fa-edit" onclick="edit_qso(' + qsoid + ')"> </i></button';
        action.innerHTML += '<button type="button"><i class="fa fa-ban" onclick="delete_qso(' + qsoid + ')"> </i></button';
    }

    var max_notes_row_id = 10

    function enter_note_in_table(note) {

        var table = document.getElementById("notestable");
        rowcount = table.rows.length
        var row = table.insertRow(rowcount - 1);
        var note_id = row.insertCell(0);
        var callsign = row.insertCell(1);
        var locator = row.insertCell(2);
        var frequency = row.insertCell(3);
        var action = row.insertCell(4);

        note_id.innerHTML = max_notes_row_id
        note_id.style = "display:none;"

        callsign.innerHTML = note["callsign"].toUpperCase()
        locator.innerHTML = note["locator"].toUpperCase()
        frequency.innerHTML = note["frequency"]

        cs = note["callsign"]

        action.innerHTML = `<button type="button"><i class="fa fa-ban" onclick="delete_note(${max_notes_row_id})"></i> </button>`
        if (undefined !== cs && cs.length > 0) {
            action.innerHTML += `<button type="button"><i class="fa fa-bolt" onclick="cw_call(${max_notes_row_id})"></i></button>`
            action.innerHTML += `<button type="button"><i class="fa fa-check" onclick="make_qso(${max_notes_row_id})"></i></button>`
        } else {
            action.innerHTML += `<button type="button" disabled="true" ><i class="fa fa-bolt" onclick="cw_call(${max_notes_row_id})"></i></button>`
            action.innerHTML += `<button type="button" disabled="true"><i class="fa fa-check" onclick="make_qso(${max_notes_row_id})"></i></button>`
        }
        max_notes_row_id += 1
    }

    function table_id_to_row(table, id) {

        for (i = 1; i < table.rows.length; i++) {
            let objCells = table.rows.item(i).cells;
            if (objCells.item(0).innerHTML == id) {
                return i
            }
        }
        return undefined
    }


    function delete_note(id) {
        console.log("Deleting note id ", id)
        let myTab = document.getElementById('notestable');
        myTab.deleteRow(table_id_to_row(myTab, id))

    }

    function cw_call(id) {
        console.log("Cw calling ", id)
        let myTab = document.getElementById('notestable');
        rowid = table_id_to_row(myTab, id)
        remote_callsign = myTab.rows[rowid].cells[1].innerHTML
        socket.emit('transmit_cw', {'msg': `${remote_callsign} de sm6fbq sm6fbq k`});
    }

    function clear_qso_entry_row() {
        document.getElementById("qso_id").innerText = ""
        document.getElementById("new_qso_date").value = ""
        document.getElementById("new_qso_time").value = ""
        document.getElementById("new_qso_band").value = ""
        document.getElementById("new_callsign").value = ""
        document.getElementById("new_tx_rst").value = ""
        document.getElementById("new_rx_rst").value = ""
        document.getElementById("new_locator").value = ""
        document.getElementById("new_qso_distance").innerText = ""
        document.getElementById("new_qso_square").innerText = ""
        document.getElementById("new_qso_points").innerText = ""
        document.getElementById("new_propmode").value = ""
    }

    function clear_note_entry_row() {

        document.getElementById("note_callsign").value = ""
        document.getElementById("note_locator").value = ""
        document.getElementById("note_frequency").value = ""
    }

    function clear_qso_table() {
        var table = document.getElementById("logtable");
        rowcount = table.rows.length
        if (rowcount <= 3)
            return
        for (i = 0; i < rowcount - 3; i++)
            table.deleteRow(3)
    }

    function delete_qso(id) {
        console.log("Deleting QSO id ", id)
        let myTab = document.getElementById('logtable');
        if (confirm("Ta bort QSO nr " + id + "?")) {
              socket.emit("delete_qso", {'id': id})
            myTab.deleteRow(table_id_to_row(myTab, id))
        }
    }

    function qsoIdRowInTable(id) {
        let myTab = document.getElementById('logtable');
        let tr = myTab.getElementsByTagName("tr");
        for (i = 3; i < tr.length; i++) {
            td = tr[i].getElementsByTagName("td")[0];
            if (td) {
                txtValue = td.textContent || td.innerText;
                if (txtValue == id) {
                    return i;
                }
            }
        }
        console.log("QSO ID ", id, " not found in log table");
        return undefined;
    }
    function edit_qso(id) {
        console.log("Editing QSO id ", id);
        i = qsoIdRowInTable(id);
        if (i) {
            let myTab = document.getElementById('logtable');
            let tr = myTab.getElementsByTagName("tr");
            trels = tr[i].getElementsByTagName("td");
            console.log("trels=", trels);
            document.getElementById("qso_id").innerText = trels[0].innerText;
            document.getElementById("new_qso_date").value = trels[1].innerText;
            document.getElementById("new_qso_time").value = trels[2].innerText;
            document.getElementById("new_qso_band").value = trels[3].innerText;
            document.getElementById("new_callsign").value = trels[4].innerText;
            document.getElementById("new_tx_rst").value = trels[5].innerText;
            document.getElementById("new_rx_rst").value = trels[6].innerText;
            document.getElementById("new_locator").value = trels[7].innerText;
            document.getElementById("new_propmode").value = trels[9].innerText;
        }
    }


    function commit_new_qso() {
        givenQSOId = document.getElementById("qso_id").innerText;
        new_qso["id"] = givenQSOId
        new_qso["callsign"] = document.getElementById("new_callsign").value;
        new_qso["tx"] = document.getElementById("new_tx_rst").value;
        new_qso["rx"] = document.getElementById("new_rx_rst").value;
        new_qso["date"] = document.getElementById("new_qso_date").value;
        new_qso["time"] = document.getElementById("new_qso_time").value;
        new_qso["band"] = document.getElementById("new_qso_band").value;
        new_qso["locator"] = document.getElementById("new_locator").value;
        new_qso["propmode"] = document.getElementById("new_propmode").value;
        new_qso["complete"] = true;


        socket.emit("commit_qso", new_qso,);

        socket.once("qso_committed", function (json) {
            new_qso["id"] = json["id"]
            // enter_qso_in_table(new_qso)
            console.log("QSO committed, given QSO ID=", givenQSOId);

            if (givenQSOId)
            {
                console.log("Finding table row for qsoid", givenQSOId);
                i = qsoIdRowInTable(givenQSOId);
                if (i)
                {
                    console.log("Qsoid", givenQSOId, " is on row ", i);
                    update_qso_in_table(json, i);
                }
                else
                {
                    console.log("Qsoid", givenQSOId, " not found in table ");
                }
            }
            else
            {
                //console.log("QSO entering into log table");
                //enter_qso_in_table(new_qso);
                if (new_qso["rx"].length > 2)
                {
                    console.log("Transmitting 73");
                    socket.emit('transmit_cw', {'msg': 'RR FB 73 # ee'});
                }
            }
            clear_qso_entry_row()
        });
    }

    function commit_incomplete_qso() {
        givenQSOId = document.getElementById("qso_id").innerText;
        new_qso["id"] = givenQSOId
        new_qso["callsign"] = document.getElementById("new_callsign").value;
        new_qso["date"] = document.getElementById("new_qso_date").value
        new_qso["time"] = document.getElementById("new_qso_time").value
        new_qso["band"] = document.getElementById("new_qso_band").value
        new_qso["tx"] = document.getElementById("new_tx_rst").value
        new_qso["rx"] = document.getElementById("new_rx_rst").value
        new_qso["locator"] = document.getElementById("new_locator").value;
        new_qso["propmode"] = document.getElementById("new_propmode").value;
        new_qso["complete"] = false;

        socket.emit("commit_qso", new_qso);

        socket.once("qso_committed", function (json) {
            new_qso["id"] = json["id"]
            // enter_qso_in_table(new_qso)
            console.log("QSO committed, given QSO ID=", givenQSOId);

            if (givenQSOId)
            {
                console.log("Finding table row for qsoid", givenQSOId);
                i = qsoIdRowInTable(givenQSOId);
                if (i)
                {
                    console.log("Qsoid", givenQSOId, " is on row ", i);
                    update_qso_in_table(json, i);
                }
                else
                {
                    console.log("Qsoid", givenQSOId, " not found in table ");
                }
            }
            else
            {
                console.log("QSO entering into log table");
                enter_qso_in_table(new_qso);
                if (new_qso["rx"].length > 2)
                {
                    console.log("Transmitting 73");
                    socket.emit('transmit_cw', {'msg': 'RR FB 73 # ee'});
                }
            }
            clear_qso_entry_row()
        });
    }

    function commit_new_note() {
        new_note = {
            "callsign": "",
            "locator": "",
            "frequency": "",
        }


        new_note["callsign"] = document.getElementById("note_callsign").value
        new_note["locator"] = document.getElementById("note_locator").value
        new_note["frequency"] = document.getElementById("note_frequency").value


        //socket.emit("commit_note", new_note);
        //
        //socket.once("note_committed", function (json) { //
        //    new_qso["id"] = json["id"] });
        cs = new_note["callsign"]
        loc = new_note["locator"]
        if ((undefined === cs || cs.length === 0) && (undefined === loc || loc.length === 0)) {
            return
        }
        enter_note_in_table(new_note)
        clear_note_entry_row()
    }

    function rmRect(id) {
        document.getElementById(id).setMap(null)
    }
</script>
<script>

</script>
</body>
</html>
